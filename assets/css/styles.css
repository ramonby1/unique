const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];

/* NAV */
document.addEventListener('DOMContentLoaded', ()=>{
  const tgl=$('.nav-toggle'), menu=$('#nav-menu');
  if(tgl&&menu){ tgl.addEventListener('click',()=>{ const o=menu.classList.toggle('open'); tgl.setAttribute('aria-expanded',o);}); }
  $('#year') && ($('#year').textContent=new Date().getFullYear());
  // flechas: scroll suave
  $$('a.down-arrow').forEach(a=>{
    a.addEventListener('click', e=>{
      if(a.hash){ e.preventDefault(); document.querySelector(a.hash).scrollIntoView({behavior:'smooth'}); }
    });
  });
});

/* DESTINOS (2 niveles) */
const DESTS = {
  "Baleares":["Mallorca","Menorca","Ibiza","Formentera"],
  "Canarias":["Gran Canaria","Tenerife","Lanzarote"],
  "Catalunya":["Costa Brava","Barcelona","Sitges","Cadaqués"]
};
function rebuildDestinations(){
  const l1=$('#dest-l1'), l2=$('#dest-l2'), title=$('#dest-l2-title');
  if(!l1||!l2) return;
  const regions=Object.keys(DESTS);
  l1.innerHTML = regions.map((r,i)=>`<li><a href="#" data-region="${r}" class="${i===0?'active':''}">${r}</a></li>`).join('');
  renderL2(regions[0]);

  function renderL2(region){
    title.textContent = region;
    l2.innerHTML = DESTS[region].map(a=>`<li><a href="listing.html?city=${encodeURIComponent(a)}">${a}</a></li>`).join('');
    $$('#dest-l1 a').forEach(a=>a.classList.toggle('active',a.dataset.region===region));
  }
  l1.onmouseover = e=>{ const a=e.target.closest('a[data-region]'); if(a) renderL2(a.dataset.region); };
  l1.onclick     = e=>{ const a=e.target.closest('a[data-region]'); if(a){ e.preventDefault(); renderL2(a.dataset.region);} };
  l2.onclick = e=>{
    const a=e.target.closest('a'); if(!a) return;
    $('#destino').value = a.textContent.trim();
    $('#form-destinations').style.display='none';
  };
}
function setupDestinationPanel(){
  const input=$('#destino'), panel=$('#form-destinations');
  if(!input||!panel) return;
  const open=()=>{ panel.style.display='block'; };
  const close=()=>{ panel.style.display='none'; };
  input.addEventListener('focus', open);
  input.addEventListener('click', open);
  input.addEventListener('input', open);
  panel.addEventListener('mouseenter', open);
  document.addEventListener('mouseover', e=>{
    if(e.target===input || panel.contains(e.target)) return;
    const label = input.closest('label'); if(label && label.contains(e.target)) return;
    close();
  });
  document.addEventListener('click', e=>{
    if(e.target===input || panel.contains(e.target)) return;
    close();
  });
}

/* TEMÁTICAS */
const THEMES = ['Deportes','Aventura','Gastro','Tour','Recreativo','Eventos','Bienestar','En familia','Todo incluido','Sol y Playa','Escapadas a ciudad','Montaña y Esquí','Lujo','Icónico','Acuático'];
function buildThemes(){ const sel=$('#theme'); if(!sel) return; sel.innerHTML = `<option value="">Cualquier temática</option>` + THEMES.map(x=>`<option>${x}</option>`).join(''); }

/* DATE RANGE */
let startDate=null,endDate=null;
function fmt(d){ if(!d) return ''; const p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`; }
function sameDay(a,b){ return a&&b&&a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate(); }
function monthLabel(d){ return d.toLocaleString('es-ES',{month:'long',year:'numeric'}); }
function renderCalendar(base){
  const panel=$('#date-range'); if(!panel) return;
  const today=new Date(); today.setHours(0,0,0,0); base=base||startDate||today;
  const add=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};
  const first=(y,m)=>new Date(y,m,1);

  function monthHTML(firstDay){
    const y=firstDay.getFullYear(), m=firstDay.getMonth();
    const startGrid=add(first(y,m),-((first(y,m).getDay()+6)%7));
    const dows=['Lun.','Mar.','Mié.','Jue.','Vie.','Sáb.','Dom.'];
    let cells='';
    for(let i=0;i<42;i++){
      const cur=add(startGrid,i), out=cur.getMonth()!==m;
      const cls=['day']; if(out) cls.push('out');
      if(startDate && sameDay(cur,startDate)) cls.push('start');
      if(endDate && sameDay(cur,endDate)) cls.push('end');
      if(startDate && endDate && cur>startDate && cur<endDate) cls.push('in-range');
      cells+=`<div class="${cls.join(' ')}" data-date="${cur.toISOString()}">${cur.getDate()}</div>`;
    }
    return `<div class="cal"><header><span class="m">${monthLabel(firstDay)}</span></header>
      <div class="grid-days">${dows.map(x=>`<div class="dow">${x}</div>`).join('')}${cells}</div></div>`;
  }

  const next=first(base.getFullYear(),base.getMonth()+1);
  panel.innerHTML=`
    <div class="range-cal">${monthHTML(base)}${monthHTML(next)}</div>
    <div class="range-actions">
      <button type="button" class="btn" id="clearRange">Borrar</button>
      <button type="button" class="btn" id="closeRange">Confirmar</button>
    </div>`;

  $$('.day[data-date]').forEach(d=>{
    d.onclick=()=>{
      const v=new Date(d.dataset.date);
      if(!startDate || (startDate && endDate)){ startDate=v; endDate=null; }
      else if(v < startDate){ endDate=startDate; startDate=v; }
      else { endDate=v; }
      updateInputs(); renderCalendar(startDate||base);
    };
  });
  $('#clearRange').onclick=()=>{ startDate=endDate=null; updateInputs(); renderCalendar(base); };
  $('#closeRange').onclick=()=> $('#date-range').style.display='none';

  function updateInputs(){
    $('#checkin').value=fmt(startDate);
    $('#checkout').value=fmt(endDate);
    if(startDate && endDate){
      const f=d=>d.toLocaleString('es-ES',{weekday:'short',day:'numeric',month:'short'});
      $('#dates').value = `${f(startDate)} – ${f(endDate)}`;
    }else if(startDate){ const f=d=>d.toLocaleString('es-ES',{weekday:'short',day:'numeric',month:'short'}); $('#dates').value=`${f(startDate)} – …`; }
    else $('#dates').value='';
  }
}
function setupDateRange(){
  const input=$('#dates'), panel=$('#date-range'); if(!input||!panel) return;
  const open=()=>{ panel.style.display='block'; renderCalendar(); };
  const close=()=>{ panel.style.display='none'; };
  input.addEventListener('focus', open);
  input.addEventListener('click', open);
  document.addEventListener('mouseover', e=>{ if(e.target===input || panel.contains(e.target)) return; close(); });
  document.addEventListener('click', e=>{ if(e.target===input || panel.contains(e.target)) return; close(); });
}

/* GUESTS */
function setupGuests(){
  const panel=$('#guests-panel'), field=$('#guests'); if(!panel||!field) return;
  const st={adults:2,children:0,babies:0};
  const clamp=k=>{ if(st[k]<0) st[k]=0; if(k==='adults'&&st[k]===0) st[k]=1; };
  const update=()=>{ $('#gv-adults').textContent=st.adults; $('#gv-children').textContent=st.children; $('#gv-babies').textContent=st.babies; field.value=st.adults+st.children+st.babies; };
  panel.addEventListener('click', e=>{
    const b=e.target.closest('button[data-k]'); if(!b) return;
    const k=b.dataset.k, d=parseInt(b.dataset.g,10); st[k]+=d; clamp(k); update();
  });
  $('#guests-ok').onclick=()=> panel.style.display='none';
  update();
}

/* CHATBOT */
function setupChat(){
  const btn=$('#chatbot'), box=$('#chatbox'), frm=$('#chat-form'), log=$('#chat-log'), input=$('#chat-input'), close=$('#chat-close');
  if(!btn||!box) return;
  const open=()=>{ box.style.display='block'; input.focus(); };
  const hide=()=> box.style.display='none';
  btn.onclick=open; close.onclick=hide;
  frm.onsubmit=(e)=>{ e.preventDefault(); const text=input.value.trim(); if(!text) return;
    log.insertAdjacentHTML('beforeend', `<div class="msg user">${text}</div>`);
    input.value=''; setTimeout(()=>{ const reply = smartReply(text); log.insertAdjacentHTML('beforeend', `<div class="msg bot">${reply}</div>`); log.scrollTop=log.scrollHeight; }, 400);
    log.scrollTop=log.scrollHeight;
  };
  function smartReply(t){
    const s=t.toLowerCase();
    if(s.includes('mallorca')) return 'Mallorca es fantástica para navegación y calas. ¿Te apetece un paseo en barco o un spa?';
    if(s.includes('precio')||s.includes('budget')) return 'Dinos fechas y personas y te proponemos las mejores opciones.';
    return 'Te ayudo a personalizar tu viaje: dime destino, fechas y temática.';
  }
}

/* INIT */
document.addEventListener('DOMContentLoaded', ()=>{
  rebuildDestinations();
  setupDestinationPanel();
  buildThemes();
  setupDateRange();
  setupGuests();
  setupChat();
});
